<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Cantina Senai</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside class="sidebar">
        <div class="logo">Espaço Gourmet - Senai</div>
        <nav>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="produtos.html">Produtos</a></li>
                <li class="ativo"><a href="pedidos.html">Pedidos</a></li>
                <li><a href="relatorios.html">Relatórios</a></li>
                <li><a href="configuracoes.html">Configurações</a></li>
                <li><a href="#" class="logout">Sair</a></li>
            </ul>
        </nav>
    </aside>

    <div class="main-content">
        <header class="header">
            <h2>Gerenciamento de Pedidos</h2>
            <div class="user-info">
                <span>Olá, Seja Bem Vindo(a) !</span>
            </div>
        </header>

        <main class="content-area">
            <div class="pedidos-acoes">
                <input type="text" placeholder="Buscar pedido por ID, nome..." class="busca-input" id="buscaPedido">
                <select class="filtro-status" id="filtroStatus">
                    <option value="todos">Mostrar Todos</option>
                    <option value="novo">Novo</option>
                    <option value="preparo">Em Preparo</option>
                    <option value="pronto">Pronto</option>
                    <option value="entregue">Entregue</option>
                </select>
                <button class="botao-novo" id="btnNovoPedido">+ Novo Pedido</button>
            </div>

            <div class="tabela-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente/Mesa</th>
                            <th>Itens do Pedido</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Hora do Pedido</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modalPedido" class="modal">
        <div class="modal-conteudo">
            <span class="fechar-modal">&times;</span>
            <h2 id="modalTitulo">Adicionar Novo Pedido</h2>
            <form id="formPedido">
                <input type="hidden" id="pedidoId">
                <div class="form-grupo">
                    <label for="cliente">Cliente / Mesa:</label>
                    <input type="text" id="cliente" required>
                </div>
                <div class="form-grupo">
                    <label for="itens">Itens do Pedido:</label>
                    <input type="text" id="itens" required>
                </div>
                <div class="form-grupo">
                    <label for="total">Total (R$):</label>
                    <input type="number" id="total" step="0.01" min="0" required>
                </div>
                <div class="form-grupo">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        <option value="novo">Novo</option>
                        <option value="preparo">Em Preparo</option>
                        <option value="pronto">Pronto</option>
                        <option value="entregue">Entregue</option>
                    </select>
                </div>
                <button type="submit">Salvar Pedido</button>
            </form>
        </div>
    </div>

    <script>
        // Proteção de acesso
        const usuario = localStorage.getItem("usuarioLogado");
        if(!usuario) window.location.href = "index1.html";

        const btnSair = document.querySelector(".logout");
        btnSair.addEventListener("click", () => {
            localStorage.removeItem("usuarioLogado");
            window.location.href = "index1.html";
        });

        let pedidos = [];
        let proximoId = 1;

        function salvarPedidos() {
            localStorage.setItem("pedidos", JSON.stringify(pedidos));
        }

        function carregarPedidos() {
            const dadosSalvos = localStorage.getItem("pedidos");
            if(dadosSalvos){
                pedidos = JSON.parse(dadosSalvos);
                proximoId = pedidos.length ? Math.max(...pedidos.map(p => p.id)) +1 :1;
            } else {
                pedidos = [];
                salvarPedidos();
            }
        }

        const corpoTabela = document.querySelector('table tbody');
        const modal = document.getElementById('modalPedido');
        const fechar = document.querySelector('.fechar-modal');
        const btnNovo = document.getElementById('btnNovoPedido');
        const modalTitulo = document.getElementById('modalTitulo');
        const form = document.getElementById('formPedido');

        function abrirModal(modo, pedido={}){
            modal.style.display='block';
            if(modo==='adicionar'){
                modalTitulo.textContent='Adicionar Novo Pedido';
                form.reset();
                document.getElementById('pedidoId').value='';
                document.getElementById('status').value='novo';
            } else {
                modalTitulo.textContent=`Editar Pedido #${pedido.id}`;
                document.getElementById('pedidoId').value = pedido.id;
                document.getElementById('cliente').value = pedido.cliente;
                document.getElementById('itens').value = pedido.itens;
                document.getElementById('total').value = pedido.total.toFixed(2);
                document.getElementById('status').value = pedido.status;
            }
        }

        function fecharModal(){ modal.style.display='none'; }

        function excluirPedido(id){
            if(confirm(`Excluir pedido #${id}?`)){
                pedidos = pedidos.filter(p=>p.id!==id);
                salvarPedidos();
                renderizarTabela();
            }
        }

        function mudarStatus(id, novoStatus){
            const pedido = pedidos.find(p=>p.id===id);
            if(pedido){
                pedido.status=novoStatus;
                salvarPedidos();
                renderizarTabela();
            }
        }

        function renderizarTabela(){
            corpoTabela.innerHTML='';
            const filtro = document.getElementById('filtroStatus').value;
            const busca = document.getElementById('buscaPedido').value.toLowerCase();

            pedidos.filter(p=>{
                return (filtro==='todos'||p.status===filtro) &&
                       (p.cliente.toLowerCase().includes(busca)||String(p.id).includes(busca));
            }).forEach(pedido=>{
                const linha = corpoTabela.insertRow();
                linha.insertCell().textContent = `#${pedido.id}`;
                linha.insertCell().textContent = pedido.cliente;
                linha.insertCell().textContent = pedido.itens;
                linha.insertCell().textContent = `R$ ${pedido.total.toFixed(2).replace('.',',')}`;
                linha.insertCell().textContent = pedido.status;
                linha.insertCell().textContent = pedido.hora;
                const acoes = linha.insertCell();
                
                if(pedido.status==='novo') acoes.innerHTML+=`<button onclick="mudarStatus(${pedido.id},'preparo')">Iniciar Preparo</button>`;
                if(pedido.status==='preparo') acoes.innerHTML+=`<button onclick="mudarStatus(${pedido.id},'pronto')">Marcar Pronto</button>`;
                if(pedido.status==='pronto') acoes.innerHTML+=`<button onclick="mudarStatus(${pedido.id},'entregue')">Finalizar</button>`;

                acoes.innerHTML+=` <button onclick="abrirModal('editar', ${JSON.stringify(pedido)})">Editar</button>`;
                acoes.innerHTML+=` <button onclick="excluirPedido(${pedido.id})">Excluir</button>`;
            });
        }

        form.addEventListener('submit', e=>{
            e.preventDefault();
            const id = document.getElementById('pedidoId').value;
            const cliente = document.getElementById('cliente').value;
            const itens = document.getElementById('itens').value;
            const total = parseFloat(document.getElementById('total').value);
            const status = document.getElementById('status').value;

            if(id){
                const index = pedidos.findIndex(p=>p.id==id);
                pedidos[index]={...pedidos[index],cliente,itens,total,status};
            } else {
                pedidos.push({
                    id: proximoId++,
                    cliente,itens,total,status,
                    hora: new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})
                });
            }
            salvarPedidos();
            fecharModal();
            renderizarTabela();
        });

        btnNovo.onclick=()=>abrirModal('adicionar');
        fechar.onclick=fecharModal;
        window.onclick=e=>{if(e.target==modal)fecharModal();}
        document.getElementById('filtroStatus').addEventListener('change',renderizarTabela);
        document.getElementById('buscaPedido').addEventListener('input',renderizarTabela);

        document.addEventListener('DOMContentLoaded', ()=>{
            carregarPedidos();
            renderizarTabela();
        });
    </script>
</body>
</html>
